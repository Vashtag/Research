<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sigmoid PU Calculator</title>
  <style>
    :root { font-family: Arial, sans-serif; }
    body { margin: 24px; color: #1f2937; background: #f8fafc; }
    h1 { margin-bottom: 8px; }
    .card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.1); margin-bottom: 16px; }
    .small { font-size: 12px; color: #6b7280; }
    .controls { margin: 10px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; color: #fff; background: #2563eb; }
    button:hover { background: #1d4ed8; }
    .btn-secondary { background: #4b5563; }
    .btn-secondary:hover { background: #374151; }
    .error { color: #b91c1c; font-weight: 600; min-height: 20px; }

    .grid-wrap { overflow: auto; border: 1px solid #d1d5db; border-radius: 8px; max-height: 430px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #d1d5db; padding: 0; }
    .input-grid th { background: #f3f4f6; position: sticky; top: 0; z-index: 2; }
    .input-grid input {
      width: 100%; border: none; padding: 7px; box-sizing: border-box;
      font-size: 13px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    .input-grid input:focus { outline: 2px solid #93c5fd; outline-offset: -2px; }
    .group-pd { background: #e0f2fe !important; }
    .group-dp { background: #dcfce7 !important; }

    .result-table th, .result-table td { padding: 8px; text-align: right; }
    .result-table th:first-child, .result-table td:first-child { text-align: left; }
  </style>
</head>
<body>
  <h1>Pre-VR Upright PU Calculator</h1>
  <p class="small">Paste all 16 columns directly from Excel. Left block is p-d (x + 7 columns), right block is d-p (x + 7 columns).</p>

  <div class="card">
    <div class="controls">
      <button id="addRows" class="btn-secondary" type="button">Add 10 Rows</button>
      <button id="clearGrid" class="btn-secondary" type="button">Clear Grid</button>
      <button id="runCalc" type="button">Calculate PU</button>
    </div>

    <div class="grid-wrap">
      <table class="input-grid">
        <thead>
          <tr>
            <th class="group-pd"><input data-header="0" value="p-d_x"></th>
            <th class="group-pd"><input data-header="1" value="p-d_grey"></th>
            <th class="group-pd"><input data-header="2" value="p-d_room_0"></th>
            <th class="group-pd"><input data-header="3" value="p-d_room_60"></th>
            <th class="group-pd"><input data-header="4" value="p-d_room_120"></th>
            <th class="group-pd"><input data-header="5" value="p-d_room_180"></th>
            <th class="group-pd"><input data-header="6" value="p-d_room_240"></th>
            <th class="group-pd"><input data-header="7" value="p-d_room_300"></th>
            <th class="group-dp"><input data-header="8" value="d-p_x"></th>
            <th class="group-dp"><input data-header="9" value="d-p_grey"></th>
            <th class="group-dp"><input data-header="10" value="d-p_room_0"></th>
            <th class="group-dp"><input data-header="11" value="d-p_room_60"></th>
            <th class="group-dp"><input data-header="12" value="d-p_room_120"></th>
            <th class="group-dp"><input data-header="13" value="d-p_room_180"></th>
            <th class="group-dp"><input data-header="14" value="d-p_room_240"></th>
            <th class="group-dp"><input data-header="15" value="d-p_room_300"></th>
          </tr>
        </thead>
        <tbody id="gridBody"></tbody>
      </table>
    </div>

    <p id="message" class="error"></p>
  </div>

  <div class="card">
    <h3>Results (p-d, d-p, and PU)</h3>
    <div id="results">No results yet.</div>
    <p class="small">PU formulas used: <strong>b(PU) = (|b(p-d)| + |b(d-p)|)/2</strong>, <strong>x0(PU) = ((x0(p-d) + x0(d-p))/2) - 180</strong>.</p>
  </div>

  <script>
    const TOTAL_COLUMNS = 16;
    const DEFAULT_ROWS = 45;

    function createRow(rowIndex) {
      const tr = document.createElement('tr');
      for (let c = 0; c < TOTAL_COLUMNS; c += 1) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.dataset.row = String(rowIndex);
        input.dataset.col = String(c);
        td.appendChild(input);
        tr.appendChild(td);
      }
      return tr;
    }

    function addRows(count) {
      const body = document.getElementById('gridBody');
      const start = body.children.length;
      for (let i = 0; i < count; i += 1) body.appendChild(createRow(start + i));
    }

    function clearGrid() {
      document.querySelectorAll('#gridBody input').forEach((input) => { input.value = ''; });
    }

    function parseNumber(value) {
      const cleaned = value.trim();
      if (!cleaned) return null;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }

    function headerNames() {
      const headers = [];
      document.querySelectorAll('thead input[data-header]').forEach((input, idx) => {
        headers.push(input.value.trim() || `col_${idx + 1}`);
      });
      return headers;
    }

    function collectData() {
      const headers = headerNames();
      const rows = [...document.querySelectorAll('#gridBody tr')];

      const pdX = [];
      const dpX = [];
      const pdSeries = Array.from({ length: 7 }, () => []);
      const dpSeries = Array.from({ length: 7 }, () => []);

      rows.forEach((row) => {
        const cells = [...row.querySelectorAll('input')];
        if (cells.length < TOTAL_COLUMNS) return;

        const xPd = parseNumber(cells[0].value);
        if (xPd !== null) {
          pdX.push(xPd);
          for (let i = 0; i < 7; i += 1) pdSeries[i].push(parseNumber(cells[i + 1].value));
        }

        const xDp = parseNumber(cells[8].value);
        if (xDp !== null) {
          dpX.push(xDp);
          for (let i = 0; i < 7; i += 1) dpSeries[i].push(parseNumber(cells[i + 9].value));
        }
      });

      if (pdX.length === 0 && dpX.length === 0) throw new Error('No valid x values found in the p-d or d-p x columns.');

      return { headers, pdX, pdSeries, dpX, dpSeries };
    }

    function handleGridPaste(event) {
      const target = event.target;
      if (!(target instanceof HTMLInputElement) || !target.closest('#gridBody')) return;

      const pasted = event.clipboardData?.getData('text');
      if (!pasted) return;
      event.preventDefault();

      const rowStart = Number(target.dataset.row);
      const colStart = Number(target.dataset.col);
      const lines = pasted.replace(/\r/g, '').split('\n').filter((line) => line.length > 0);
      const matrix = lines.map((line) => line.split('\t'));

      const neededRows = rowStart + matrix.length;
      const currentRows = document.querySelectorAll('#gridBody tr').length;
      if (neededRows > currentRows) addRows(neededRows - currentRows + 5);

      matrix.forEach((cells, rOffset) => {
        const r = rowStart + rOffset;
        cells.forEach((value, cOffset) => {
          const c = colStart + cOffset;
          if (c >= TOTAL_COLUMNS) return;
          const cell = document.querySelector(`#gridBody input[data-row="${r}"][data-col="${c}"]`);
          if (cell) cell.value = value.trim();
        });
      });
    }

    function sigmoid(x, b, x0) {
      const z = -(x - x0) / b;
      if (z > 60) return 0;
      if (z < -60) return 1;
      return 1 / (1 + Math.exp(z));
    }

    function sse(data, b, x0) {
      let err = 0;
      for (const [x, y] of data) {
        const d = sigmoid(x, b, x0) - y;
        err += d * d;
      }
      return err;
    }

    function rSquared(data, b, x0) {
      const meanY = data.reduce((sum, [, y]) => sum + y, 0) / data.length;
      let ssRes = 0;
      let ssTot = 0;
      for (const [x, y] of data) {
        const pred = sigmoid(x, b, x0);
        ssRes += (y - pred) ** 2;
        ssTot += (y - meanY) ** 2;
      }
      if (ssTot === 0) return NaN;
      return 1 - (ssRes / ssTot);
    }

    function fitColumn(data, direction) {
      const xs = data.map(([x]) => x);
      const minX = Math.min(...xs);
      const maxX = Math.max(...xs);

      let bestErr = Infinity;
      let bestB = direction === 'dp' ? 1 : -1;
      let bestX0 = 0;

      const bMin = direction === 'dp' ? 0.05 : -200;
      const bMax = direction === 'dp' ? 200 : 0.95;
      const x0Min = Math.floor(minX - 100);
      const x0Max = Math.ceil(maxX + 100);

      for (let b = bMin; b <= bMax; b += 0.5) {
        if (Math.abs(b) < 1e-9) continue;
        if (direction === 'pd' && !(b < 1)) continue;
        if (direction === 'dp' && !(b > 0)) continue;

        for (let x0 = x0Min; x0 <= x0Max; x0 += 1) {
          const err = sse(data, b, x0);
          if (err < bestErr) {
            bestErr = err;
            bestB = b;
            bestX0 = x0;
          }
        }
      }

      let stepB = 5;
      let stepX0 = 5;
      while (stepB > 1e-4) {
        let improved = false;
        for (const db of [0, -stepB, stepB]) {
          for (const dx of [0, -stepX0, stepX0]) {
            const candB = bestB + db;
            if (Math.abs(candB) < 1e-9) continue;
            if (direction === 'pd' && !(candB < 1)) continue;
            if (direction === 'dp' && !(candB > 0)) continue;
            const candX0 = bestX0 + dx;
            const err = sse(data, candB, candX0);
            if (err < bestErr) {
              bestErr = err;
              bestB = candB;
              bestX0 = candX0;
              improved = true;
            }
          }
        }
        if (!improved) {
          stepB /= 2;
          stepX0 /= 2;
        }
      }

      return { b: bestB, x0: bestX0, r2: rSquared(data, bestB, bestX0), sse: bestErr, n: data.length };
    }

    function renderResults(rows) {
      const htmlRows = rows.map((row) => `
        <tr>
          <td>${row.name}</td>
          <td>${row.pdB}</td><td>${row.pdX0}</td><td>${row.pdR2}</td>
          <td>${row.dpB}</td><td>${row.dpX0}</td><td>${row.dpR2}</td>
          <td>${row.puB}</td><td>${row.puX0}</td>
        </tr>
      `).join('');

      return `
        <table class="result-table">
          <thead>
            <tr>
              <th>Column</th>
              <th>p-d b</th><th>p-d x0</th><th>p-d R²</th>
              <th>d-p b</th><th>d-p x0</th><th>d-p R²</th>
              <th>PU b</th><th>PU x0</th>
            </tr>
          </thead>
          <tbody>${htmlRows}</tbody>
        </table>
      `;
    }

    function toFmt(v) {
      return Number.isFinite(v) ? v.toFixed(4) : 'NaN';
    }

    function runCalculation() {
      const msg = document.getElementById('message');
      const resultsDiv = document.getElementById('results');
      msg.textContent = '';

      try {
        const { headers, pdX, pdSeries, dpX, dpSeries } = collectData();
        const rows = [];

        for (let i = 0; i < 7; i += 1) {
          const pdPoints = [];
          for (let r = 0; r < pdX.length; r += 1) {
            const y = pdSeries[i][r];
            if (y !== null) pdPoints.push([pdX[r], y]);
          }

          const dpPoints = [];
          for (let r = 0; r < dpX.length; r += 1) {
            const y = dpSeries[i][r];
            if (y !== null) dpPoints.push([dpX[r], y]);
          }

          const pdFit = pdPoints.length >= 3 ? fitColumn(pdPoints, 'pd') : null;
          const dpFit = dpPoints.length >= 3 ? fitColumn(dpPoints, 'dp') : null;

          const puB = (pdFit && dpFit) ? (Math.abs(pdFit.b) + Math.abs(dpFit.b)) / 2 : NaN;
          const puX0 = (pdFit && dpFit) ? ((pdFit.x0 + dpFit.x0) / 2) - 180 : NaN;

          rows.push({
            name: headers[i + 1].replace(/^p-d_/, ''),
            pdB: toFmt(pdFit?.b),
            pdX0: toFmt(pdFit?.x0),
            pdR2: toFmt(pdFit?.r2),
            dpB: toFmt(dpFit?.b),
            dpX0: toFmt(dpFit?.x0),
            dpR2: toFmt(dpFit?.r2),
            puB: toFmt(puB),
            puX0: toFmt(puX0),
          });
        }

        resultsDiv.innerHTML = renderResults(rows);
      } catch (error) {
        resultsDiv.textContent = 'No results yet.';
        msg.textContent = error.message;
      }
    }

    addRows(DEFAULT_ROWS);
    document.getElementById('gridBody').addEventListener('paste', handleGridPaste);
    document.getElementById('addRows').addEventListener('click', () => addRows(10));
    document.getElementById('clearGrid').addEventListener('click', clearGrid);
    document.getElementById('runCalc').addEventListener('click', runCalculation);
  </script>
</body>
</html>
